# Implementation Plan

- [x] 1. プロジェクト基盤セットアップ
- [x] 1.1 Wasmビルド環境の構築
  - Cargo.tomlにcdylib/rlibクレートタイプ、wasm-bindgen、web-sys（feature flags付き）、console_error_panic_hookの依存関係を設定する
  - src/main.rsをsrc/lib.rsに置き換え、wasm-bindgenのpreludeをインポートしたスケルトンを作成する
  - wasm-packでビルドが成功し、pkg/ディレクトリにJSグルーコードとWasmバイナリが生成されることを確認する
  - .gitignoreにpkg/とtarget/を追加する
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 2. マンデルブロ集合計算コアの実装
- [x] 2.1 (P) 単一ピクセルの反復計算
  - 複素数の反復計算 z = z² + c を実行し、|z| > 2.0 で発散と判定する関数を実装する
  - 最大反復回数を引数として受け取り、その回数に達しても発散しないピクセルを集合内として識別する
  - スムーズカラーリング用の連続値（発散時の正規化反復回数）を計算して返す
  - ユニットテスト: 既知の集合内座標 (0, 0) → 未発散、集合外座標 (2, 2) → 即座発散、境界付近の座標 → 期待反復回数
  - _Requirements: 1.1, 1.2, 5.3, 6.1_

- [x] 2.2 (P) 領域一括計算
  - ビューポート情報を使用して、指定領域の全ピクセルに対する反復計算を一括実行する関数を実装する
  - 反復回数とスムーズ値を個別のバッファに書き込み、呼び出し元が再利用できるようにする
  - ユニットテスト: 小さな領域（例: 4x4）での一括計算が個別計算と一致することを検証する
  - _Requirements: 1.1, 1.2, 6.1_

- [x] 3. ビューポート管理の実装
- [x] 3.1 (P) ビューポート状態と座標変換
  - 複素平面の中心座標、スケール、キャンバスサイズを保持するビューポート構造を実装する
  - 初期表示領域として実部 -2.0〜1.0、虚部 -1.5〜1.5 付近をアスペクト比を考慮して設定する
  - ピクセル座標から複素平面座標への変換関数を実装する
  - ユニットテスト: キャンバス中心ピクセルがビューポート中心座標に一致することを検証する
  - _Requirements: 4.3, 4.4_

- [x] 3.2 (P) ズーム・パン操作
  - 指定ピクセル位置を中心にスケールを変更するズーム機能を実装する
  - ピクセル差分に基づいて表示領域を移動するパン機能を実装する
  - ユニットテスト: ズーム後のscale変化、パン後の中心座標移動を検証する
  - _Requirements: 4.3_

- [x] 4. カラーマッピングの実装
- [x] 4.1 (P) 基本カラーマッピング
  - 反復回数をHSLベースのグラデーションに変換し、RGBA値として返す関数を実装する
  - 集合内ピクセル（未発散）は黒色 (0, 0, 0, 255) を返すようにする
  - ユニットテスト: 未発散→黒色、発散→非黒色のRGBA値を検証する
  - _Requirements: 1.3, 1.4, 5.1, 5.2_

- [x] 4.2 (P) スムーズカラーリングと一括変換
  - スムーズ値を使用して連続的な色遷移を実現し、バンディングを軽減する
  - 反復回数バッファとスムーズ値バッファを受け取り、RGBAバッファに直接書き込む一括変換関数を実装する
  - ユニットテスト: 隣接する反復回数のピクセル間で色が滑らかに遷移することを検証する
  - _Requirements: 1.3, 5.1, 5.3_

- [x] 5. Wasmバインディング（Renderer）の実装
- [x] 5.1 Renderer構造体とコンストラクタ
  - ビューポート、中間バッファ（反復回数・スムーズ値）、最大反復回数を保持するRenderer構造体をwasm_bindgenでエクスポートする
  - コンストラクタでキャンバスサイズに応じた中間バッファを確保し、初期ビューポートを設定する
  - console_error_panic_hookの初期化を行い、パニック時のエラーメッセージを改善する
  - 幅・高さのゲッターと最大反復回数のセッターをエクスポートする
  - _Requirements: 2.2, 3.3, 6.2_

- [x] 5.2 描画パイプラインの統合
  - JS側から渡されるu8スライスに対して、計算コア→カラーマッピング→バッファ書き込みの一連の描画パイプラインを実行するrender関数を実装する
  - ズーム・パン操作をRenderer経由でビューポートに委譲するメソッドをエクスポートする
  - ユニットテスト: 既知のビューポートに対するrender呼び出しで、バッファに有効なRGBA値が書き込まれることを検証する
  - _Requirements: 2.2, 3.1, 6.2_

- [x] 6. フロントエンド統合
- [x] 6.1 HTMLページとWasmロード
  - Canvas要素を含むHTMLページを作成し、ES moduleとしてWasmモジュールをロードするスクリプトを記述する
  - Rendererを初期化し、ImageDataバッファを作成して初回描画を実行するJavaScriptコードを実装する
  - ブラウザでページを開いてマンデルブロ集合が正しく描画されることを手動確認する
  - _Requirements: 2.3, 3.1, 3.2_

- [x] 6.2 ズーム・パンのイベントハンドリング
  - マウスホイールイベントでカーソル位置を中心にズームイン・ズームアウトを行うイベントリスナーを実装する
  - マウスドラッグで表示領域をパンするイベントリスナーを実装する
  - requestAnimationFrameを使用して再描画をスケジュールし、UIスレッドのブロッキングを防止する
  - ブラウザでズーム・パン操作が滑らかに動作することを手動確認する
  - _Requirements: 4.1, 4.2, 6.3_
